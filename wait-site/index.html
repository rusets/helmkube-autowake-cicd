<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Helmkube Autowake ‚Äî Wake Console</title>
<style>
:root{--bg:#070711;--fg:#e8f7ff;--muted:#a8b2c6;--glass:rgba(255,255,255,.06);--glass-border:rgba(255,255,255,.16);--accent:#00eaff;--ok:#00ffb4;--warn:#ffcc00}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;background:var(--bg);color:var(--fg);font-family:Manrope,Inter,system-ui,Segoe UI,Roboto,sans-serif;display:grid;place-items:center;overflow:hidden}
.brand{position:fixed;top:14px;left:16px;z-index:10;display:flex;gap:8px;align-items:center;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(8px);box-shadow:0 6px 24px rgba(0,0,0,.35)}
.brand-link{display:flex;gap:8px;align-items:center;text-decoration:none;font-weight:700;letter-spacing:.2px;color:inherit;transition:opacity .25s ease}
.brand-link:hover{opacity:.8}
.brand .txt{background:linear-gradient(90deg,#00eaff,#a677ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.glowTL,.glowBR{position:fixed;width:60vmax;height:60vmax;border-radius:50%;filter:blur(120px);opacity:.5;z-index:0}
.glowTL{top:-20vmax;left:-15vmax;background:radial-gradient(circle,#00eaff,transparent 60%)}
.glowBR{right:-20vmax;bottom:-15vmax;background:radial-gradient(circle,#ff00cc,transparent 60%)}
.grid{position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,.05) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.05) 1px,transparent 1px);background-size:40px 40px;mask-image:radial-gradient(circle at center,black 60%,transparent 80%)}
.card{position:relative;z-index:2;width:min(680px,92vw);padding:46px 38px 34px;border-radius:18px;background:var(--glass);border:1px solid var(--glass-border);backdrop-filter:blur(10px);text-align:center;box-shadow:0 10px 60px rgba(0,0,0,.4)}
h1{margin:0 0 8px;color:#bdf8ff;text-shadow:0 0 14px #00eaff55;font-size:2.1rem}
p.sub{margin:0 0 18px;color:#c4cfde}
.progress{margin:16px auto 8px;width:90%;max-width:560px;text-align:left}
.bar-wrap{height:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);border-radius:999px;overflow:hidden}
.bar{height:100%;width:0%;background:linear-gradient(90deg,#ff00cc,#ff8800,#00ffd5,#00aaff,#a677ff);background-size:200% 100%;animation:barFlow 7s ease infinite}
@keyframes barFlow{50%{background-position:100% 0}}
.stages{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
.stage{padding:8px 6px;border-radius:10px;text-align:center;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);color:var(--muted);font-weight:600;font-size:.9rem}
.stage.done{color:var(--ok);border-color:rgba(0,255,180,.65);box-shadow:0 0 16px rgba(0,255,180,.15) inset}
.stage.active{color:#fff;border-color:#00eaff;box-shadow:0 0 18px rgba(0,234,255,.2) inset}
.loader{width:78px;height:78px;margin:18px auto;border:3px solid rgba(255,255,255,.18);border-left-color:#ff00cc;border-right-color:#00eaff;border-radius:50%;animation:spin 2.4s linear infinite;animation-play-state:paused}
.loader.go{animation-play-state:running}
.loader.stop{animation-play-state:paused;opacity:.7;border-left-color:var(--ok);border-right-color:var(--ok)}
@keyframes spin{to{transform:rotate(360deg)}}
.row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:6px}
button{appearance:none;border:none;border-radius:10px;padding:12px 22px;font-weight:700;letter-spacing:.4px;cursor:pointer;transition:.25s;font-variant-numeric:tabular-nums}
#wake,#open{background:rgba(0,255,180,.08);border:1px solid #00ffb4;color:#00ffb4;min-width:200px;height:48px}
#wake:disabled,#open:disabled{opacity:.45;border-color:#3a5;color:#7aa;cursor:not-allowed}
#wake:hover:not(:disabled),#open:hover:not(:disabled){box-shadow:0 0 24px rgba(0,255,180,.18) inset,0 0 22px rgba(0,255,180,.15);transform:translateY(-1px)}
.warn{display:none;margin:12px auto 0;max-width:560px;background:rgba(255,204,0,.12);border:1px solid rgba(255,204,0,.6);color:#ffe07a;border-radius:10px;padding:10px 12px;font-weight:700}
.warn.show{display:block}
.eta{font-variant-numeric:tabular-nums;color:#bfefff}
footer{position:fixed;bottom:12px;width:100%;text-align:center;color:#94a1b2;font-size:.8rem}
</style>
</head>
<body>
<div class="brand">
  <a href="https://rusets.com" target="_blank" rel="noopener noreferrer" class="brand-link">
    üöÄ <span class="txt">Ruslan AWS</span>
  </a>
</div>
<div class="glowTL"></div><div class="glowBR"></div><div class="grid"></div>

<main class="card">
  <h1>Wake Helmkube Cluster</h1>
  <p class="sub" id="subtitle">Click ‚ÄúWake up‚Äù to start the k3s demo environment.</p>

  <div class="progress">
    <div class="bar-wrap"><div class="bar" id="bar"></div></div>
    <div class="stages">
      <div class="stage" id="s1">EC2</div>
      <div class="stage" id="s2">k3s</div>
      <div class="stage" id="s3">Helm</div>
      <div class="stage" id="s4">App</div>
    </div>
  </div>

  <div class="loader" id="spinner"></div>

  <div class="row">
    <button id="wake">Wake up</button>
    <button id="open" disabled>Open App</button>
  </div>

  <p id="status-text" style="color:var(--muted);margin-top:10px">
    ETA <span class="eta" id="eta">00:00 / 03:00</span>
  </p>
  <div id="warn" class="warn">‚ö†Ô∏è Don‚Äôt refresh this page while the cluster is waking up.</div>
</main>

<footer>Helmkube Autowake ¬∑ AWS ¬∑ Terraform ¬∑ GitHub Actions ¬∑ k3s</footer>

<script>
const WAKE_URL="https://q2hhpdzk5l.execute-api.us-east-1.amazonaws.com/";
const STATUS_URL="https://q2hhpdzk5l.execute-api.us-east-1.amazonaws.com/status";
const OPEN_URL="http://54.88.152.10:30080/";

const BTN_OPEN=document.getElementById("open");
const BTN_WAKE=document.getElementById("wake");
const TEXT=document.getElementById("status-text");
const SUB=document.getElementById("subtitle");
const BAR=document.getElementById("bar");
const SPINNER=document.getElementById("spinner");
const WARN=document.getElementById("warn");
const ETA_EL=document.getElementById("eta");
const STAGES=[{id:"s1"},{id:"s2"},{id:"s3"},{id:"s4"}];

let stageIndex=0,percent=0,isReady=false;
let progressTimer=null,cooldownTimer=null,statusTimer=null;

const COOLDOWN_SEC=5*60;
const PROGRESS_ETA_SEC=1*60; 
const LS_KEY="helmkube_wake_last_ts";
const FLAG_KEY="helmkube_wake_inflight";

function setStage(i){
  STAGES.forEach((s,idx)=>{
    const el=document.getElementById(s.id);
    el.classList.remove("active","done");
    if(idx<i)el.classList.add("done");
    if(idx===i)el.classList.add("active");
  });
}

function setPercent(p){
  percent=Math.max(0,Math.min(100,p));
  BAR.style.width=percent+"%";
}

function fmtMMSS(sec){
  sec=Math.max(0,Math.floor(sec));
  const m=String(Math.floor(sec/60)).padStart(2,"0");
  const s=String(sec%60).padStart(2,"0");
  return`${m}:${s}`;
}

function lastTs(){
  const v=localStorage.getItem(LS_KEY);
  return v?Number(v):0;
}

function setLastNow(){
  localStorage.setItem(LS_KEY,String(Date.now()));
}

function clearLast(){
  localStorage.removeItem(LS_KEY);
}

function isInflight(){
  return localStorage.getItem(FLAG_KEY)==="1";
}

function setInflight(v){
  if(v){
    localStorage.setItem(FLAG_KEY,"1");
  }else{
    localStorage.removeItem(FLAG_KEY);
  }
}

function msLeftCooldown(){
  const t=lastTs();
  if(!t)return 0;
  const left=(t+COOLDOWN_SEC*1000)-Date.now();
  return left>0?left:0;
}

function applyCooldownUI(){
  const leftSec=Math.ceil(msLeftCooldown()/1000);
  if(leftSec>0){
    BTN_WAKE.disabled=true;
    BTN_WAKE.textContent=`Wake up ${fmtMMSS(leftSec)}`;
  }else{
    BTN_WAKE.disabled=false;
    BTN_WAKE.textContent="Wake up";
  }
}

function minReadyDelayPassed(){
  const t=lastTs();
  if(!t)return false;
  return Date.now() - t >= PROGRESS_ETA_SEC*1000;
}

function startCooldownTick(){
  if(cooldownTimer)clearInterval(cooldownTimer);
  cooldownTimer=setInterval(()=>{
    const left=msLeftCooldown();
    if(left===0){
      clearInterval(cooldownTimer);
      cooldownTimer=null;
      clearLast();
      applyCooldownUI();
      if(!isInflight())WARN.classList.remove("show");
      return;
    }
    applyCooldownUI();
  },500);
}

function startProgressTick(){
  if(progressTimer)return;
  progressTimer=setInterval(()=>{
    const t=lastTs();
    if(!t)return;
    const elapsed=Math.max(0,Math.floor((Date.now()-t)/1000));
    const ratio=Math.min(1,elapsed/PROGRESS_ETA_SEC);
    setPercent(Math.floor(ratio*100));
    ETA_EL.textContent=`${fmtMMSS(elapsed)} / ${fmtMMSS(PROGRESS_ETA_SEC)}`;

    if(percent>24&&stageIndex===0){
      stageIndex=1;
      setStage(stageIndex);
      SUB.textContent="Starting EC2 instance‚Ä¶";
    }
    if(percent>55&&stageIndex===1){
      stageIndex=2;
      setStage(stageIndex);
      SUB.textContent="Booting k3s and system services‚Ä¶";
    }
    if(percent>80&&stageIndex===2){
      stageIndex=3;
      setStage(stageIndex);
      SUB.textContent="Deploying app via Helm‚Ä¶";
    }
  },1000);
}

function stopProgressTick(){
  if(progressTimer){
    clearInterval(progressTimer);
    progressTimer=null;
  }
}

function resetUIToIdle(){
  stageIndex=0;
  setStage(0);
  setPercent(0);
  SUB.textContent="Click ‚ÄúWake up‚Äù to start the k3s demo environment.";
  TEXT.textContent="ETA "+fmtMMSS(0)+" / "+fmtMMSS(PROGRESS_ETA_SEC);
  BTN_OPEN.disabled=true;
  BTN_OPEN.textContent="Open App";
  SPINNER.classList.remove("go");
  SPINNER.classList.remove("stop");
  WARN.classList.remove("show");
  ETA_EL.textContent=`${fmtMMSS(0)} / ${fmtMMSS(PROGRESS_ETA_SEC)}`;
}

async function pollStatusOnce(){
  const res=await fetch(STATUS_URL+"?t="+Date.now(),{cache:"no-store"});
  const data=await res.json();
  return String(data.state||data.status||"").toLowerCase();
}

function showWakingUI(){
  BTN_OPEN.disabled=true;
  BTN_OPEN.textContent="Open App";
  SPINNER.classList.add("go");
  WARN.classList.add("show");
  TEXT.textContent="Waking up‚Ä¶ stay on this tab.";
  if(!progressTimer)startProgressTick();
}

function showIdleUI(){
  SPINNER.classList.remove("go");
  WARN.classList.remove("show");
  resetUIToIdle();
}

function startStatusLoop(){
  if(statusTimer)return;

  async function tick(){
    try{
      const state=await pollStatusOnce();

      if(state==="ready"||state==="running"){
        isReady=true;
        setStage(4);
        setPercent(100);

        const t=lastTs();
        const elapsed=t?Math.max(0,Math.floor((Date.now()-t)/1000)):PROGRESS_ETA_SEC;
        const total=PROGRESS_ETA_SEC;
        ETA_EL.textContent=`${fmtMMSS(Math.min(elapsed,total))} / ${fmtMMSS(total)}`;

        if(minReadyDelayPassed()){
          BTN_OPEN.disabled=false;
          BTN_OPEN.textContent="Open App";
          TEXT.textContent="Cluster is ready ‚Äî open the app.";
        }else{
          BTN_OPEN.disabled=true;
          BTN_OPEN.textContent="Open App (warming up‚Ä¶)";
          TEXT.textContent="Cluster is ready ‚Äî finishing warm-up‚Ä¶";
        }

        SUB.textContent="All systems go.";
        SPINNER.classList.remove("go");
        SPINNER.classList.add("stop");
        WARN.classList.remove("show");
        setInflight(false);
        stopProgressTick();
        applyCooldownUI();
      }else if(state==="idle"||state==="stopped"){
        isReady=false;
        setInflight(false);
        showIdleUI();
        applyCooldownUI();
        stopProgressTick();
      }else{
        if(isInflight()||msLeftCooldown()>0){
          showWakingUI();
        }else{
          setInflight(false);
          showIdleUI();
          applyCooldownUI();
        }
      }
    }catch(e){
      if(msLeftCooldown()===0&&!isInflight()){
        showIdleUI();
        applyCooldownUI();
        stopProgressTick();
      }
    }
    statusTimer=setTimeout(tick,1000);
  }

  tick();
}

BTN_OPEN.addEventListener("click",e=>{
  if(!isReady||!minReadyDelayPassed()){
    e.preventDefault();
    return;
  }
  window.location.href=OPEN_URL;
});

BTN_WAKE.addEventListener("click",async()=>{
  if(msLeftCooldown()>0)return;

  setLastNow();
  setInflight(true);
  applyCooldownUI();
  startCooldownTick();

  try{
    const r=await fetch(WAKE_URL,{method:"GET",cache:"no-store",mode:"cors",credentials:"omit"});
    if(!(r.ok||r.status===202))throw new Error("Wake failed: "+r.status);
  }catch(e){
    TEXT.textContent="Wake error: "+e.message;
    return;
  }

  stageIndex=0;
  setStage(0);
  setPercent(0);
  ETA_EL.textContent=`${fmtMMSS(0)} / ${fmtMMSS(PROGRESS_ETA_SEC)}`;
  showWakingUI();
});

(function init(){
  if(msLeftCooldown()===0)clearLast();
  applyCooldownUI();

  if(msLeftCooldown()>0||isInflight()){
    startCooldownTick();
    startProgressTick();
  }else{
    setInflight(false);
    showIdleUI();
  }

  startStatusLoop();
})();
</script>